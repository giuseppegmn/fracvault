name: Anchor Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config libssl-dev libudev-dev \
            ca-certificates curl git python3 make g++ \
            jq

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Rust alto o suficiente pra MSRVs recentes (solana-program 2.x, toml_parser, etc.)
      - name: Setup Rust (pinned)
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: "1.82.0"
          components: rustfmt, clippy

      - name: Detect versions from contracts/Cargo.lock
        id: vers
        shell: bash
        run: |
          set -euxo pipefail

          test -f contracts/Cargo.lock

          # Extrai versão do anchor-lang
          ANCHOR_LANG_VERSION="$(
            awk '
              $0 ~ /^name = "anchor-lang"$/ {found=1}
              found && $0 ~ /^version = "/ {gsub(/version = "|"/, "", $0); print $0; exit}
            ' contracts/Cargo.lock
          )"

          # Extrai versão do solana-program
          SOLANA_PROGRAM_VERSION="$(
            awk '
              $0 ~ /^name = "solana-program"$/ {found=1}
              found && $0 ~ /^version = "/ {gsub(/version = "|"/, "", $0); print $0; exit}
            ' contracts/Cargo.lock
          )"

          echo "anchor_lang_version=$ANCHOR_LANG_VERSION" >> "$GITHUB_OUTPUT"
          echo "solana_program_version=$SOLANA_PROGRAM_VERSION" >> "$GITHUB_OUTPUT"

          echo "Detected anchor-lang: $ANCHOR_LANG_VERSION"
          echo "Detected solana-program: $SOLANA_PROGRAM_VERSION"

      - name: Install Solana CLI (match solana-program if possible)
        shell: bash
        run: |
          set -euxo pipefail

          SOLANA_TARGET="v${{ steps.vers.outputs.solana_program_version }}"
          FALLBACK="v1.18.26"

          download_and_install() {
            local ver="$1"
            echo "Trying Solana CLI $ver"
            curl -fL "https://github.com/solana-labs/solana/releases/download/${ver}/solana-release-x86_64-unknown-linux-gnu.tar.bz2" -o solana.tar.bz2
            tar -xjf solana.tar.bz2
            echo "$PWD/solana-release/bin" >> "$GITHUB_PATH"
            # Não coloca solana/bin na frente do PATH pra não “sequestrar” rustc
            export PATH="$PATH:$PWD/solana-release/bin"
            solana --version
          }

          if ! download_and_install "$SOLANA_TARGET"; then
            echo "Solana $SOLANA_TARGET not available as a release tarball; falling back to $FALLBACK"
            rm -rf solana-release solana.tar.bz2 || true
            download_and_install "$FALLBACK"
          fi

      - name: Install Anchor CLI (match anchor-lang, isolated)
        shell: bash
        run: |
          set -euxo pipefail

          ANCHOR_VER="${{ steps.vers.outputs.anchor_lang_version }}"
          test -n "$ANCHOR_VER"

          export CARGO_HOME="$RUNNER_TEMP/cargo-home"
          export CARGO_TARGET_DIR="$RUNNER_TEMP/cargo-target"
          export ANCHOR_ROOT="$RUNNER_TEMP/anchor-root"
          mkdir -p "$CARGO_HOME" "$CARGO_TARGET_DIR" "$ANCHOR_ROOT"

          cargo install \
            --git https://github.com/coral-xyz/anchor \
            --tag "v${ANCHOR_VER}" \
            anchor-cli \
            --locked \
            --root "$ANCHOR_ROOT"

          echo "$ANCHOR_ROOT/bin" >> "$GITHUB_PATH"
          export PATH="$PATH:$ANCHOR_ROOT/bin"

          anchor --version
          command -v anchor

      - name: Install JS deps (root)
        shell: bash
        run: |
          set -euxo pipefail
          npm install --no-audit --no-fund

      # ⚠️ Para de deletar Cargo.lock: isso é o que cria “dependência surpresa”
      - name: Run anchor tests
        working-directory: contracts
        shell: bash
        run: |
          set -euxo pipefail
          solana --version
          anchor --version
          anchor test
